"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[3961],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=r.createContext({}),c=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return r.createElement(s.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},h=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),u=c(n),h=o,m=u["".concat(s,".").concat(h)]||u[h]||d[h]||a;return n?r.createElement(m,i(i({ref:t},p),{},{components:n})):r.createElement(m,i({ref:t},p))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,i=new Array(a);i[0]=h;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[u]="string"==typeof e?e:o,i[1]=l;for(var c=2;c<a;c++)i[c]=n[c];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}h.displayName="MDXCreateElement"},6775:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>u,frontMatter:()=>a,metadata:()=>l,toc:()=>c});var r=n(7462),o=(n(7294),n(3905));const a={id:"entity-framework",title:"Using Entity Framework",sidebar_label:"Entity Framework",sidebar_position:2},i=void 0,l={unversionedId:"development/entity-framework",id:"development/entity-framework",title:"Using Entity Framework",description:"DbContext and Parallel Query Operations",source:"@site/docs/development/entity-framework.md",sourceDirName:"development",slug:"/development/entity-framework",permalink:"/docs/development/entity-framework",draft:!1,tags:[],version:"current",sidebarPosition:2,frontMatter:{id:"entity-framework",title:"Using Entity Framework",sidebar_label:"Entity Framework",sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"Unit Testing",permalink:"/docs/development/unit-testing"},next:{title:"How it Works",permalink:"/docs/reference/how-it-works"}},s={},c=[{value:"DbContext and Parallel Query Operations",id:"dbcontext-and-parallel-query-operations",level:2},{value:"Register DbContext as Transient",id:"register-dbcontext-as-transient",level:2},{value:"Execute Controller Actions in Isolation",id:"execute-controller-actions-in-isolation",level:2}],p={toc:c};function u(e){let{components:t,...a}=e;return(0,o.kt)("wrapper",(0,r.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"dbcontext-and-parallel-query-operations"},"DbContext and Parallel Query Operations"),(0,o.kt)("p",null,"In a standard REST application we would register our ",(0,o.kt)("inlineCode",{parentName:"p"},"DbContext")," like so:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-csharp",metastring:'title="Adding Entity Framework at Startup"',title:'"Adding',Entity:!0,Framework:!0,at:!0,'Startup"':!0},'services.AddDbContext<AppDbContext>(o =>\n{\n    o.UseSqlServer("<connectionString>");\n});\n')),(0,o.kt)("p",null,"This default registration adds the ",(0,o.kt)("inlineCode",{parentName:"p"},"DbContext")," to the DI container is as a ",(0,o.kt)("inlineCode",{parentName:"p"},"Scoped")," service. Meaning one instance is generated per Http request. However, consider the following graph controller and query:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-csharp",metastring:'title="FoodController.cs"',title:'"FoodController.cs"'},"public class FoodController : GraphController\n{    \n    private AppDbContext _context;\n    public FoodController(AppDbContext context){}\n\n    [QueryRoot]\n    public IFood SearchMeat(string name){}\n\n    [QueryRoot]\n    public IFood SearchVeggies(string name){}\n}\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-graphql",metastring:'title="Sample Query"',title:'"Sample','Query"':!0},'query {\n    searchMeat(name: "steak*") {\n        name\n    }\n    searchVeggies(name: "green*") {\n        name\n    }\n}\n')),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"FoodController")," contains two action methods both of which are executed by the query. This means two instances of the controller are needed, once for each field resolution, since they are executed in parallel. While the controller itself is registered with the DI container as transient the ",(0,o.kt)("inlineCode",{parentName:"p"},"DbContext")," is not, it is shared between the controller instances.  This can result in an exception being thrown :"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Ef Core Error",src:n(5990).Z,width:"1350",height:"575"})),(0,o.kt)("p",null,"This is caused by graphql attempting to execute both controller actions simultaneously. Ef Core will reject multiple active queries. There are a few ways to handle this and each comes with its own trade offs:"),(0,o.kt)("h2",{id:"register-dbcontext-as-transient"},"Register DbContext as Transient"),(0,o.kt)("p",null,"One way to correct this problem is to register your DbContext\nas a transient object."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-csharp",metastring:'title="Register DbContext as Transient"',title:'"Register',DbContext:!0,as:!0,'Transient"':!0},'public void ConfigureServices(IServiceCollection services)\n{\n    services.AddDbContext<AppDbContext>(o =>\n        {\n            o.UseSqlServer("<connectionString>");\n        }, ServiceLifetime.Transient);\n}\n')),(0,o.kt)("p",null,"Now each controller instance will get its own DbContext and the queries can execute in parallel without issue. "),(0,o.kt)("p",null,"The tradeoff here is that you lose the singular scoped unit-of-work for the whole request granted by the shared context. "),(0,o.kt)("p",null,"If you have services registered to the DI container that make use of the DbContext you would want to register them as ",(0,o.kt)("inlineCode",{parentName:"p"},"Transient")," as well lest one scoped service be created for the request trapping a single DbContext instance. Sometimes, however; this is unavoidable, especially with legacy code..."),(0,o.kt)("h2",{id:"execute-controller-actions-in-isolation"},"Execute Controller Actions in Isolation"),(0,o.kt)("p",null,"Another option is to instruct graphql to execute its controller actions in sequence, rather than in parallel. "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-csharp",metastring:'title="Isolate GraphQL Controller Actions"',title:'"Isolate',GraphQL:!0,Controller:!0,'Actions"':!0},"services.AddGraphQL(o =>\n{\n    o.ExecutionOptions.ResolverIsolation = ResolverIsolationOptions.ControllerActions;\n}\n")),(0,o.kt)("p",null,"This will instruct graphql to execute each encountered controller action one after the other. Your scoped ",(0,o.kt)("inlineCode",{parentName:"p"},"DbContext")," would then be able to process the queries without issue."),(0,o.kt)("p",null,"The tradeoff with this method is an increase in processing time since the methods are called in sequence. All other field resolutions would be executed in parallel."),(0,o.kt)("p",null,"If your application has other resources or services that may have similar restrictions, it can be beneficial to isolate the other resolver types as well. You can add them to the ResolverIsolation configuration option as needed."))}u.isMDXComponent=!0},5990:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/ef-core-error-914a473f2072ee38b60344444d4d1795.png"}}]);